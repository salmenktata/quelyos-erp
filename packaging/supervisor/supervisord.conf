[supervisord]
nodaemon=true
user=root
logfile=/var/log/quelyos/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/quelyos/supervisor

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# ============================================================================
# PostgreSQL Database
# ============================================================================
[program:postgresql]
command=/usr/lib/postgresql/14/bin/postgres -D /var/lib/postgresql/14/main -c config_file=/etc/postgresql/14/main/postgresql.conf
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/quelyos/postgresql.log
stderr_logfile=/var/log/quelyos/postgresql.err.log
startsecs=5
stopwaitsecs=30

# ============================================================================
# Odoo Backend
# ============================================================================
[program:odoo]
command=/usr/bin/python3 /opt/odoo/odoo/odoo-bin
    --addons-path=/opt/odoo/addons/quelyos,/opt/odoo/odoo/addons
    -d %(ENV_QUELYOS_DB_NAME)s
    --db-filter=^%(ENV_QUELYOS_DB_NAME)s$
    --db_host=127.0.0.1
    --db_port=5432
    --db_user=%(ENV_QUELYOS_DB_USER)s
    --db_password=%(ENV_QUELYOS_DB_PASSWORD)s
    --http-port=8069
    --workers=2
    --max-cron-threads=1
    --limit-time-real=600
    --limit-time-cpu=300
    --without-demo=all
    --logfile=/var/log/quelyos/odoo/odoo.log
user=odoo
autostart=true
autorestart=true
priority=20
stdout_logfile=/var/log/quelyos/odoo/odoo-stdout.log
stderr_logfile=/var/log/quelyos/odoo/odoo-stderr.log
startsecs=10
stopwaitsecs=30
environment=HOME="/opt/odoo",USER="odoo"

# Attendre que PostgreSQL soit prÃªt
depends_on=postgresql

# ============================================================================
# Frontend Next.js
# ============================================================================
[program:frontend]
command=/usr/bin/node /opt/quelyos/frontend/server.js
directory=/opt/quelyos/frontend
user=root
autostart=true
autorestart=true
priority=30
stdout_logfile=/var/log/quelyos/frontend.log
stderr_logfile=/var/log/quelyos/frontend.err.log
startsecs=5
stopwaitsecs=10
environment=NODE_ENV="production",PORT="3000",HOSTNAME="0.0.0.0",NEXT_TELEMETRY_DISABLED="1"

# Attendre Odoo
depends_on=odoo

# ============================================================================
# Nginx Reverse Proxy
# ============================================================================
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
priority=40
stdout_logfile=/var/log/quelyos/nginx/nginx-stdout.log
stderr_logfile=/var/log/quelyos/nginx/nginx-stderr.log
startsecs=2
stopwaitsecs=5

# Attendre frontend
depends_on=frontend

# ============================================================================
# Groupe de tous les services
# ============================================================================
[group:quelyos]
programs=postgresql,odoo,frontend,nginx
priority=999
