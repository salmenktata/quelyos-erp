#!/bin/bash

# Hook pre-commit : D√©tection r√©f√©rences Odoo dans UI
# Bloque commits avec "Odoo" visible dans frontend/backoffice (hors legal/)

echo "üîç V√©rification r√©f√©rences Odoo dans UI..."

# Fichiers stag√©s pour commit
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(frontend/src|backoffice/src)/.*\.(tsx?|jsx?)$' | grep -v 'legal/')

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Recherche violations P0
VIOLATIONS=""
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Grep pour "Odoo" dans strings/tooltips (hors commentaires)
    MATCHES=$(grep -n -i 'odoo' "$file" | grep -v '^\s*//' | grep -v 'lib/odoo')
    if [ -n "$MATCHES" ]; then
      VIOLATIONS="$VIOLATIONS\n‚ùå $file:\n$MATCHES\n"
    fi
  fi
done

if [ -n "$VIOLATIONS" ]; then
  echo "üö´ COMMIT BLOQU√â - R√©f√©rences Odoo d√©tect√©es dans UI:"
  echo -e "$VIOLATIONS"
  echo ""
  echo "üí° Solutions:"
  echo "   1. Utiliser /no-odoo --fix pour corrections automatiques"
  echo "   2. Remplacer manuellement (voir .claude/commands/no-odoo.md)"
  echo ""
  echo "‚úÖ Exception autoris√©e: frontend/src/app/legal/page.tsx (conformit√© LGPL)"
  exit 1
fi

echo "‚úÖ Aucune r√©f√©rence Odoo dans UI"
exit 0
