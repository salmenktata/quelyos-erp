#!/bin/bash
# Pre-commit hook: D√©tection r√©f√©rences Odoo UI
# Bloque les commits contenant des violations P0

set -e

echo "üîç V√©rification r√©f√©rences Odoo..."

# Fichiers exclus (conformit√© LGPL + code API interne)
EXCLUSIONS="legal/page.tsx|lib/odoo|odoo-rpc.ts|__tests__|node_modules"

# Patterns P0 critiques (visibles utilisateur)
PATTERNS=(
  "dans Odoo"
  "via Odoo"
  "l'interface Odoo"
  "g√©r√©es dans Odoo"
  "configur√©es dans Odoo"
  "ID Odoo"
  "OdooImage"
  "VITE_ODOO_URL"
  "ODOO_URL"
)

# V√©rifier uniquement les fichiers staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ Aucun fichier TypeScript modifi√©"
  exit 0
fi

VIOLATIONS=""

for pattern in "${PATTERNS[@]}"; do
  # Chercher le pattern dans les fichiers staged (hors exclusions)
  MATCHES=$(echo "$STAGED_FILES" | xargs grep -l "$pattern" 2>/dev/null | grep -vE "$EXCLUSIONS" || true)

  if [ -n "$MATCHES" ]; then
    VIOLATIONS="$VIOLATIONS\n‚ùå Pattern \"$pattern\" trouv√© dans:\n$MATCHES\n"
  fi
done

if [ -n "$VIOLATIONS" ]; then
  echo ""
  echo "üö® VIOLATIONS ODOO UI D√âTECT√âES"
  echo "================================"
  echo -e "$VIOLATIONS"
  echo ""
  echo "Actions requises:"
  echo "  1. Remplacer les r√©f√©rences Odoo par des termes g√©n√©riques"
  echo "  2. Voir .claude/commands/no-odoo.md pour le mapping"
  echo ""
  echo "Pour bypass (urgence uniquement):"
  echo "  git commit --no-verify"
  echo ""
  exit 1
fi

echo "‚úÖ Aucune violation Odoo d√©tect√©e"
exit 0
