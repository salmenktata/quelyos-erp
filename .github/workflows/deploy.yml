name: CD - Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

  # Permet de d√©clencher manuellement
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata Vitrine Client
        id: meta-vitrine-client
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/vitrine-client
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push Vitrine Client
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./vitrine-client/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-vitrine-client.outputs.tags }}
          labels: ${{ steps.meta-vitrine-client.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata Dashboard Client
        id: meta-dashboard-client
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/dashboard-client
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push Dashboard Client
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dashboard-client/Dockerfile
          push: true
          tags: ${{ steps.meta-dashboard-client.outputs.tags }}
          labels: ${{ steps.meta-dashboard-client.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ==========================================================================
      # BUILD & PUSH - 7 SaaS Apps (only if directory exists)
      # ==========================================================================
      - name: Build and push SaaS Apps
        run: |
          SAAS_APPS="finance-os store-os copilote-ops sales-os retail-os team-os support-os"
          for app in $SAAS_APPS; do
            if [ -d "apps/$app" ] && [ -f "apps/$app/Dockerfile" ]; then
              echo "Building $app..."
              docker buildx build \
                --platform linux/amd64 \
                -t ghcr.io/${{ github.repository }}/$app:${{ github.sha }} \
                -t ghcr.io/${{ github.repository }}/$app:latest \
                -f apps/$app/Dockerfile \
                --push \
                apps/$app
            else
              echo "Skipping $app (no directory or Dockerfile)"
            fi
          done

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/quelyos
            git pull origin main
            docker-compose -f docker-compose.prod.yml pull
            docker-compose -f docker-compose.prod.yml up -d
            docker system prune -af --volumes

      - name: Healthcheck
        run: |
          sleep 30
          curl -f https://${{ secrets.PRODUCTION_DOMAIN }}/health || exit 1

      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to production: ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
