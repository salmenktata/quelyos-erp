name: Quarterly Security Audit

# Ex√©cut√© le 1er jour de chaque trimestre (janvier, avril, juillet, octobre) √† 9h UTC
on:
  schedule:
    # 1er janvier, avril, juillet, octobre √† 9h UTC
    - cron: '0 9 1 1,4,7,10 *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # AUDIT COMPLET TRIMESTRIEL
  # ==========================================================================
  comprehensive-audit:
    name: Comprehensive Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: \${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: \${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: NPM Audit (Detailed)
        run: |
          echo "# üìä Quarterly Security Audit - \$(date +%Y-%m-%d)" >> \$GITHUB_STEP_SUMMARY
          echo "" >> \$GITHUB_STEP_SUMMARY
          echo "## 1. NPM Dependencies Audit" >> \$GITHUB_STEP_SUMMARY
          echo "" >> \$GITHUB_STEP_SUMMARY

          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          TOTAL_MODERATE=0
          TOTAL_LOW=0

          for dir in dashboard-client super-admin-client vitrine-client vitrine-quelyos api; do
            if [ -f "\$dir/package.json" ]; then
              echo "### \$dir" >> \$GITHUB_STEP_SUMMARY
              cd \$dir
              pnpm audit --json > audit.json 2>/dev/null || true

              critical=\$(jq '.metadata.vulnerabilities.critical // 0' audit.json 2>/dev/null || echo 0)
              high=\$(jq '.metadata.vulnerabilities.high // 0' audit.json 2>/dev/null || echo 0)
              moderate=\$(jq '.metadata.vulnerabilities.moderate // 0' audit.json 2>/dev/null || echo 0)
              low=\$(jq '.metadata.vulnerabilities.low // 0' audit.json 2>/dev/null || echo 0)

              TOTAL_CRITICAL=\$((TOTAL_CRITICAL + critical))
              TOTAL_HIGH=\$((TOTAL_HIGH + high))
              TOTAL_MODERATE=\$((TOTAL_MODERATE + moderate))
              TOTAL_LOW=\$((TOTAL_LOW + low))

              echo "- üî¥ Critical: \$critical" >> \$GITHUB_STEP_SUMMARY
              echo "- üü† High: \$high" >> \$GITHUB_STEP_SUMMARY
              echo "- üü° Moderate: \$moderate" >> \$GITHUB_STEP_SUMMARY
              echo "- ‚ö™ Low: \$low" >> \$GITHUB_STEP_SUMMARY
              echo "" >> \$GITHUB_STEP_SUMMARY

              # Extract detailed vulnerability info
              if [ \$critical -gt 0 ] || [ \$high -gt 0 ]; then
                echo "<details><summary>üîç Details</summary>" >> \$GITHUB_STEP_SUMMARY
                echo "" >> \$GITHUB_STEP_SUMMARY
                echo "\`\`\`json" >> \$GITHUB_STEP_SUMMARY
                jq '.vulnerabilities | to_entries | map(select(.value.severity == "critical" or .value.severity == "high")) | .[] | {name: .key, severity: .value.severity, via: .value.via}' audit.json 2>/dev/null >> \$GITHUB_STEP_SUMMARY || true
                echo "\`\`\`" >> \$GITHUB_STEP_SUMMARY
                echo "</details>" >> \$GITHUB_STEP_SUMMARY
                echo "" >> \$GITHUB_STEP_SUMMARY
              fi

              rm -f audit.json
              cd ..
            fi
          done

          echo "---" >> \$GITHUB_STEP_SUMMARY
          echo "### Summary" >> \$GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> \$GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> \$GITHUB_STEP_SUMMARY
          echo "| üî¥ Critical | \$TOTAL_CRITICAL |" >> \$GITHUB_STEP_SUMMARY
          echo "| üü† High | \$TOTAL_HIGH |" >> \$GITHUB_STEP_SUMMARY
          echo "| üü° Moderate | \$TOTAL_MODERATE |" >> \$GITHUB_STEP_SUMMARY
          echo "| ‚ö™ Low | \$TOTAL_LOW |" >> \$GITHUB_STEP_SUMMARY
          echo "" >> \$GITHUB_STEP_SUMMARY

          if [ \$TOTAL_CRITICAL -gt 0 ] || [ \$TOTAL_HIGH -gt 0 ]; then
            echo "‚ùå **CRITICAL/HIGH vulnerabilities detected!**" >> \$GITHUB_STEP_SUMMARY
            echo "" >> \$GITHUB_STEP_SUMMARY
            echo "**Action required:** Create issue and fix within 7 days" >> \$GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **No CRITICAL or HIGH vulnerabilities**" >> \$GITHUB_STEP_SUMMARY
          fi

      - name: Python Audit (Detailed)
        run: |
          echo "" >> \$GITHUB_STEP_SUMMARY
          echo "## 2. Python Dependencies Audit" >> \$GITHUB_STEP_SUMMARY
          echo "" >> \$GITHUB_STEP_SUMMARY

          pip install pip-audit safety

          if [ -f "odoo-backend/requirements.txt" ]; then
            echo "### pip-audit" >> \$GITHUB_STEP_SUMMARY
            pip-audit -r odoo-backend/requirements.txt --format json > pip-audit.json 2>/dev/null || true
            vulns=\$(jq 'length' pip-audit.json 2>/dev/null || echo 0)
            echo "Vulnerabilities found: **\$vulns**" >> \$GITHUB_STEP_SUMMARY
            echo "" >> \$GITHUB_STEP_SUMMARY

            if [ \$vulns -gt 0 ]; then
              echo "<details><summary>üîç Details</summary>" >> \$GITHUB_STEP_SUMMARY
              echo "" >> \$GITHUB_STEP_SUMMARY
              echo "\`\`\`json" >> \$GITHUB_STEP_SUMMARY
              cat pip-audit.json >> \$GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> \$GITHUB_STEP_SUMMARY
              echo "</details>" >> \$GITHUB_STEP_SUMMARY
            fi

            rm -f pip-audit.json
          fi
        continue-on-error: true

      - name: Code Quality Metrics
        run: |
          echo "" >> \$GITHUB_STEP_SUMMARY
          echo "## 3. Code Quality Metrics" >> \$GITHUB_STEP_SUMMARY
          echo "" >> \$GITHUB_STEP_SUMMARY

          # Count files
          total_ts_files=\$(find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | wc -l)
          total_py_files=\$(find . -name "*.py" | grep -v node_modules | wc -l)

          echo "| Metric | Count |" >> \$GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> \$GITHUB_STEP_SUMMARY
          echo "| TypeScript files | \$total_ts_files |" >> \$GITHUB_STEP_SUMMARY
          echo "| Python files | \$total_py_files |" >> \$GITHUB_STEP_SUMMARY
          echo "" >> \$GITHUB_STEP_SUMMARY

      - name: Security Best Practices Check
        run: |
          echo "" >> \$GITHUB_STEP_SUMMARY
          echo "## 4. Security Best Practices" >> \$GITHUB_STEP_SUMMARY
          echo "" >> \$GITHUB_STEP_SUMMARY

          # Check for console.log in production code
          console_logs=\$(grep -r "console\\.log" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.next | grep -v "logger.ts" | grep -v "test" | wc -l)

          # Check for dangerouslySetInnerHTML without sanitize
          dangerous_html=\$(grep -r "dangerouslySetInnerHTML" --include="*.tsx" --exclude-dir=node_modules | grep -v "sanitize" | wc -l)

          # Check for hardcoded secrets patterns
          secrets_pattern=\$(grep -rE "(password|secret|api_key).*=.*['\"]" --include="*.ts" --include="*.tsx" --include="*.py" --exclude-dir=node_modules --exclude-dir=.next --exclude="*.test.*" --exclude="*.spec.*" | wc -l)

          echo "| Check | Count | Status |" >> \$GITHUB_STEP_SUMMARY
          echo "|-------|-------|--------|" >> \$GITHUB_STEP_SUMMARY

          if [ \$console_logs -eq 0 ]; then
            echo "| console.log usage | \$console_logs | ‚úÖ |" >> \$GITHUB_STEP_SUMMARY
          else
            echo "| console.log usage | \$console_logs | ‚ö†Ô∏è |" >> \$GITHUB_STEP_SUMMARY
          fi

          if [ \$dangerous_html -eq 0 ]; then
            echo "| Unsanitized HTML | \$dangerous_html | ‚úÖ |" >> \$GITHUB_STEP_SUMMARY
          else
            echo "| Unsanitized HTML | \$dangerous_html | ‚ùå |" >> \$GITHUB_STEP_SUMMARY
          fi

          if [ \$secrets_pattern -eq 0 ]; then
            echo "| Potential hardcoded secrets | \$secrets_pattern | ‚úÖ |" >> \$GITHUB_STEP_SUMMARY
          else
            echo "| Potential hardcoded secrets | \$secrets_pattern | ‚ö†Ô∏è |" >> \$GITHUB_STEP_SUMMARY
          fi

      - name: Generate Issue if Critical Vulnerabilities Found
        if: always()
        run: |
          # This step would create a GitHub issue if critical vulnerabilities are found
          # Placeholder for future implementation with GitHub CLI
          echo "Issue creation workflow completed" >> \$GITHUB_STEP_SUMMARY

  # ==========================================================================
  # NOTIFICATION
  # ==========================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [comprehensive-audit]
    if: always()
    steps:
      - name: Audit completed
        run: |
          echo "Quarterly security audit completed"
          echo "Check the summary for detailed results"
          # Future: Send notification via email/Slack/Discord
